import tkinter as tk
from tkinter import scrolledtext, ttk, messagebox
import datetime
import threading
import requests
import json
from typing import List, Dict

class AIAssistant:
    def __init__(self, root):
        self.root = root
        self.root.title("ü§ñ Yapay Zeka Asistanƒ±")
        self.root.geometry("900x700")
        self.root.configure(bg="#1e1e2e")
        self.root.minsize(600, 400)
        
        # API Ayarlarƒ±
        self.api_key = "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"
        self.api_url = "https://api.groq.com/openai/v1/chat/completions"
        self.model = "llama-3.3-70b-versatile"
        
        # Konu≈üma ge√ßmi≈üi
        self.conversation_history: List[Dict[str, str]] = []
        self.max_history = 20  # Maksimum ge√ßmi≈ü mesaj sayƒ±sƒ±
        
        # Durum
        self.is_processing = False
        
        # Aray√ºz√º olu≈ütur
        self.setup_styles()
        self.create_widgets()
        self.add_welcome_message()
        
    def setup_styles(self):
        """Geli≈ümi≈ü stil ayarlarƒ±"""
        style = ttk.Style()
        style.theme_use('clam')
        
        # Progress bar stili
        style.configure(
            "Custom.Horizontal.TProgressbar",
            troughcolor='#2b2b3c',
            background='#00b4d8',
            borderwidth=0,
            thickness=3
        )
        
    def create_widgets(self):
        """Geli≈ümi≈ü aray√ºz bile≈üenleri"""
        
        # Ba≈ülƒ±k √ßer√ßevesi
        header_frame = tk.Frame(self.root, bg="#00b4d8", height=70)
        header_frame.pack(fill=tk.X, side=tk.TOP)
        header_frame.pack_propagate(False)
        
        # Ba≈ülƒ±k
        title_label = tk.Label(
            header_frame,
            text="ü§ñ YAPAY ZEKA ASƒ∞STANI",
            font=("Segoe UI", 20, "bold"),
            bg="#00b4d8",
            fg="white"
        )
        title_label.pack(side=tk.LEFT, padx=20, pady=15)
        
        # Model bilgisi
        model_label = tk.Label(
            header_frame,
            text=f"Model: {self.model}",
            font=("Segoe UI", 9),
            bg="#00b4d8",
            fg="#e0f7ff"
        )
        model_label.pack(side=tk.RIGHT, padx=20)
        
        # Temizle butonu
        clear_button = tk.Button(
            header_frame,
            text="üóëÔ∏è Temizle",
            font=("Segoe UI", 10),
            bg="#0096c7",
            fg="white",
            relief=tk.FLAT,
            cursor="hand2",
            padx=15,
            pady=5,
            command=self.clear_chat
        )
        clear_button.pack(side=tk.RIGHT, padx=5)
        
        # Ana i√ßerik √ßer√ßevesi
        main_frame = tk.Frame(self.root, bg="#1e1e2e")
        main_frame.pack(fill=tk.BOTH, expand=True, padx=15, pady=10)
        
        # Sohbet alanƒ± √ßer√ßevesi
        chat_frame = tk.Frame(main_frame, bg="#1e1e2e")
        chat_frame.pack(fill=tk.BOTH, expand=True)
        
        # Sohbet g√∂r√ºnt√ºleme alanƒ±
        self.chat_display = scrolledtext.ScrolledText(
            chat_frame,
            wrap=tk.WORD,
            font=("Segoe UI", 11),
            bg="#2b2b3c",
            fg="#ffffff",
            insertbackground="white",
            relief=tk.FLAT,
            padx=15,
            pady=15,
            borderwidth=0,
            highlightthickness=1,
            highlightbackground="#00b4d8",
            highlightcolor="#00b4d8"
        )
        self.chat_display.pack(fill=tk.BOTH, expand=True)
        self.chat_display.config(state=tk.DISABLED)
        
        # Progress bar (y√ºkleme g√∂stergesi)
        self.progress_frame = tk.Frame(main_frame, bg="#1e1e2e", height=5)
        self.progress_frame.pack(fill=tk.X, pady=(5, 0))
        
        self.progress = ttk.Progressbar(
            self.progress_frame,
            style="Custom.Horizontal.TProgressbar",
            mode='indeterminate',
            length=300
        )
        
        # Durum √ßubuƒüu
        status_frame = tk.Frame(main_frame, bg="#1e1e2e", height=25)
        status_frame.pack(fill=tk.X, pady=(5, 0))
        status_frame.pack_propagate(False)
        
        self.status_label = tk.Label(
            status_frame,
            text="‚úì Hazƒ±r",
            font=("Segoe UI", 9),
            bg="#1e1e2e",
            fg="#888888",
            anchor=tk.W
        )
        self.status_label.pack(side=tk.LEFT, fill=tk.X, expand=True)
        
        # Karakter sayacƒ±
        self.char_count_label = tk.Label(
            status_frame,
            text="0/2000",
            font=("Segoe UI", 9),
            bg="#1e1e2e",
            fg="#888888",
            anchor=tk.E
        )
        self.char_count_label.pack(side=tk.RIGHT)
        
        # Giri≈ü alanƒ± √ßer√ßevesi
        input_frame = tk.Frame(main_frame, bg="#1e1e2e")
        input_frame.pack(fill=tk.X, pady=(10, 0))
        
        # Mesaj giri≈ü √ßer√ßevesi (i√ß √ßer√ßeve)
        entry_container = tk.Frame(input_frame, bg="#2b2b3c", highlightthickness=2, 
                                   highlightbackground="#00b4d8", highlightcolor="#00b4d8")
        entry_container.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 10))
        
        # Mesaj giri≈ü alanƒ± (Text widget ile √ßok satƒ±rlƒ±)
        self.message_entry = tk.Text(
            entry_container,
            font=("Segoe UI", 11),
            bg="#2b2b3c",
            fg="white",
            insertbackground="white",
            relief=tk.FLAT,
            borderwidth=0,
            height=3,
            wrap=tk.WORD,
            padx=10,
            pady=10
        )
        self.message_entry.pack(fill=tk.BOTH, expand=True)
        self.message_entry.bind("<KeyRelease>", self.update_char_count)
        self.message_entry.bind("<Control-Return>", lambda e: self.send_message())
        self.message_entry.focus()
        
        # Buton √ßer√ßevesi
        button_frame = tk.Frame(input_frame, bg="#1e1e2e")
        button_frame.pack(side=tk.RIGHT)
        
        # G√∂nder butonu
        self.send_button = tk.Button(
            button_frame,
            text="‚û§\nG√ñNDER",
            font=("Segoe UI", 10, "bold"),
            bg="#00b4d8",
            fg="white",
            relief=tk.FLAT,
            cursor="hand2",
            padx=20,
            pady=15,
            command=self.send_message
        )
        self.send_button.pack()
        
        # Hover efektleri
        self.send_button.bind("<Enter>", lambda e: self.send_button.config(bg="#0096c7"))
        self.send_button.bind("<Leave>", lambda e: self.send_button.config(bg="#00b4d8"))
        
        # Yardƒ±m metni
        help_label = tk.Label(
            main_frame,
            text="üí° ƒ∞pucu: Enter ile yeni satƒ±r, Ctrl+Enter ile g√∂nder",
            font=("Segoe UI", 8),
            bg="#1e1e2e",
            fg="#555555"
        )
        help_label.pack(pady=(5, 0))
        
    def add_welcome_message(self):
        """Ho≈ü geldin mesajƒ±"""
        welcome = """Merhaba! Ben geli≈ümi≈ü yapay zeka asistanƒ±nƒ±zƒ±m. üéâ

Size nasƒ±l yardƒ±mcƒ± olabilirim?
‚Ä¢ Sorularƒ±nƒ±zƒ± cevaplayabilirim
‚Ä¢ Metin yazabilirim
‚Ä¢ Kod √∂nerileri sunabilirim
‚Ä¢ Genel konularda bilgi verebilirim

Soru sormaktan √ßekinmeyin!"""
        
        self.add_message("Asistan", welcome, "#00b4d8")
        
    def update_char_count(self, event=None):
        """Karakter sayacƒ±nƒ± g√ºncelle"""
        text = self.message_entry.get("1.0", tk.END).strip()
        char_count = len(text)
        self.char_count_label.config(text=f"{char_count}/2000")
        
        if char_count > 2000:
            self.char_count_label.config(fg="#ff4444")
        else:
            self.char_count_label.config(fg="#888888")
            
    def add_message(self, sender: str, message: str, color: str):
        """Geli≈ümi≈ü mesaj ekleme"""
        self.chat_display.config(state=tk.NORMAL)
        
        # Zaman damgasƒ±
        timestamp = datetime.datetime.now().strftime("%H:%M:%S")
        
        # Ayƒ±rƒ±cƒ± √ßizgi (ilk mesaj deƒüilse)
        current_text = self.chat_display.get("1.0", tk.END).strip()
        if current_text:
            self.chat_display.insert(tk.END, "\n" + "‚îÄ" * 80 + "\n\n", ("separator",))
        
        # Ba≈ülƒ±k satƒ±rƒ±
        self.chat_display.insert(tk.END, f"{sender} ", ("sender",))
        self.chat_display.insert(tk.END, f"‚Ä¢ {timestamp}\n", ("time",))
        
        # Mesaj i√ßeriƒüi
        self.chat_display.insert(tk.END, f"{message}\n", ("message",))
        
        # Stil ayarlarƒ±
        self.chat_display.tag_config("sender", foreground=color, font=("Segoe UI", 12, "bold"))
        self.chat_display.tag_config("time", foreground="#888888", font=("Segoe UI", 9))
        self.chat_display.tag_config("message", foreground="#ffffff", font=("Segoe UI", 11), spacing1=5)
        self.chat_display.tag_config("separator", foreground="#404050")
        
        self.chat_display.config(state=tk.DISABLED)
        self.chat_display.see(tk.END)
        
    def update_status(self, text: str, color: str = "#888888"):
        """Durum √ßubuƒüunu g√ºncelle"""
        self.status_label.config(text=text, fg=color)
        self.root.update_idletasks()
        
    def show_progress(self):
        """Y√ºkleme g√∂stergesini g√∂ster"""
        self.progress.pack(fill=tk.X)
        self.progress.start(10)
        
    def hide_progress(self):
        """Y√ºkleme g√∂stergesini gizle"""
        self.progress.stop()
        self.progress.pack_forget()
        
    def clear_chat(self):
        """Sohbeti temizle"""
        if messagebox.askyesno("Temizle", "T√ºm sohbet ge√ßmi≈üi silinecek. Emin misiniz?"):
            self.chat_display.config(state=tk.NORMAL)
            self.chat_display.delete("1.0", tk.END)
            self.chat_display.config(state=tk.DISABLED)
            self.conversation_history.clear()
            self.add_welcome_message()
            self.update_status("‚úì Sohbet temizlendi", "#00ff88")
            
    def get_ai_response(self, user_input: str) -> str:
        """Groq API'den yanƒ±t al - geli≈ümi≈ü hata y√∂netimi"""
        try:
            # ƒ∞lk mesajsa sistem mesajƒ± ekle
            if len(self.conversation_history) == 0:
                self.conversation_history.append({
                    "role": "system",
                    "content": """Sen T√ºrk√ße konu≈üan, profesyonel ve yardƒ±msever bir yapay zeka asistanƒ±sƒ±n. 
                    √ñzelliklerin:
                    - Her zaman T√ºrk√ße cevap verirsin
                    - Detaylƒ±, anla≈üƒ±lƒ±r ve yapƒ±landƒ±rƒ±lmƒ±≈ü yanƒ±tlar verirsin
                    - Bilmediƒüin konularda d√ºr√ºst√ße s√∂ylersin
                    - Kullanƒ±cƒ±ya saygƒ±lƒ± ve arkada≈ü canlƒ±sƒ± yakla≈üƒ±rsƒ±n
                    - Karma≈üƒ±k konularƒ± basit √∂rneklerle a√ßƒ±klarsƒ±n"""
                })
            
            # Kullanƒ±cƒ± mesajƒ±nƒ± ekle
            self.conversation_history.append({
                "role": "user",
                "content": user_input
            })
            
            # Ge√ßmi≈ü √ßok uzunsa eski mesajlarƒ± sil (sistem mesajƒ± hari√ß)
            if len(self.conversation_history) > self.max_history:
                self.conversation_history = [self.conversation_history[0]] + self.conversation_history[-(self.max_history-1):]
            
            # API isteƒüi hazƒ±rla
            headers = {
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json"
            }
            
            data = {
                "model": self.model,
                "messages": self.conversation_history,
                "temperature": 0.7,
                "max_tokens": 2048,
                "top_p": 0.9,
                "stream": False
            }
            
            # ƒ∞stek g√∂nder
            response = requests.post(
                self.api_url, 
                headers=headers, 
                json=data, 
                timeout=45
            )
            
            # Yanƒ±t kontrol√º
            if response.status_code == 200:
                result = response.json()
                ai_message = result['choices'][0]['message']['content']
                
                # Yanƒ±tƒ± ge√ßmi≈üe ekle
                self.conversation_history.append({
                    "role": "assistant",
                    "content": ai_message
                })
                
                return ai_message
                
            elif response.status_code == 401:
                self._remove_last_user_message()
                return "‚ùå **Yetkilendirme Hatasƒ±**\n\nAPI anahtarƒ±nƒ±z ge√ßersiz veya s√ºresi dolmu≈ü. L√ºtfen API anahtarƒ±nƒ±zƒ± kontrol edin."
                
            elif response.status_code == 429:
                self._remove_last_user_message()
                return "‚è≥ **Oran Sƒ±nƒ±rƒ± A≈üƒ±ldƒ±**\n\n√áok fazla istek g√∂nderildi. L√ºtfen 1-2 dakika bekleyip tekrar deneyin."
                
            elif response.status_code == 500:
                self._remove_last_user_message()
                return "üîß **Sunucu Hatasƒ±**\n\nGroq sunucularƒ±nda ge√ßici bir sorun var. L√ºtfen birka√ß saniye sonra tekrar deneyin."
                
            else:
                self._remove_last_user_message()
                try:
                    error_detail = response.json().get('error', {})
                    error_msg = error_detail.get('message', 'Bilinmeyen hata')
                    error_type = error_detail.get('type', 'unknown')
                    return f"‚ö†Ô∏è **API Hatasƒ± ({response.status_code})**\n\nTip: {error_type}\nMesaj: {error_msg}"
                except:
                    return f"‚ö†Ô∏è **HTTP Hatasƒ±**\n\nDurum kodu: {response.status_code}\nL√ºtfen daha sonra tekrar deneyin."
                    
        except requests.exceptions.Timeout:
            self._remove_last_user_message()
            return "‚è±Ô∏è **Zaman A≈üƒ±mƒ±**\n\nSunucu yanƒ±t vermedi (45 saniye). ƒ∞nternet baƒülantƒ±nƒ±z yava≈ü olabilir veya sunucu yoƒüun olabilir."
            
        except requests.exceptions.ConnectionError:
            self._remove_last_user_message()
            return "üåê **Baƒülantƒ± Hatasƒ±**\n\nƒ∞nternet baƒülantƒ±sƒ± kurulamadƒ±. L√ºtfen:\n‚Ä¢ ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin\n‚Ä¢ G√ºvenlik duvarƒ± ayarlarƒ±nƒ±zƒ± kontrol edin\n‚Ä¢ VPN kullanƒ±yorsanƒ±z kapatmayƒ± deneyin"
            
        except json.JSONDecodeError:
            self._remove_last_user_message()
            return "‚ö†Ô∏è **Veri Formatƒ± Hatasƒ±**\n\nSunucudan ge√ßersiz yanƒ±t alƒ±ndƒ±. Bu genellikle ge√ßici bir sorundur, l√ºtfen tekrar deneyin."
            
        except KeyError as e:
            self._remove_last_user_message()
            return f"‚ö†Ô∏è **Yanƒ±t Ayrƒ±≈ütƒ±rma Hatasƒ±**\n\nBeklenen veri bulunamadƒ±: {str(e)}\nL√ºtfen tekrar deneyin."
            
        except Exception as e:
            self._remove_last_user_message()
            return f"‚ùå **Beklenmeyen Hata**\n\n{type(e).__name__}: {str(e)}\n\nBu hatayƒ± g√∂rmemeliydiniz. L√ºtfen uygulamayƒ± yeniden ba≈ülatƒ±n."
            
    def _remove_last_user_message(self):
        """Hata durumunda son kullanƒ±cƒ± mesajƒ±nƒ± ge√ßmi≈üten √ßƒ±kar"""
        if self.conversation_history and self.conversation_history[-1]["role"] == "user":
            self.conversation_history.pop()
            
    def send_message(self):
        """Mesaj g√∂nder - geli≈ümi≈ü versiyon"""
        # Zaten i≈ülem yapƒ±lƒ±yorsa √ßƒ±k
        if self.is_processing:
            return
            
        user_message = self.message_entry.get("1.0", tk.END).strip()
        
        if not user_message:
            messagebox.showwarning("Uyarƒ±", "L√ºtfen bir mesaj yazƒ±n!")
            return
            
        if len(user_message) > 2000:
            messagebox.showerror("Hata", "Mesajƒ±nƒ±z √ßok uzun! Maksimum 2000 karakter olabilir.")
            return
        
        # ƒ∞≈ülem ba≈ülat
        self.is_processing = True
        self.send_button.config(state=tk.DISABLED, text="‚è≥\nG√ñNDERƒ∞Lƒ∞YOR")
        self.message_entry.config(state=tk.DISABLED)
        self.update_status("‚è≥ G√∂nderiliyor...", "#ffaa00")
        self.show_progress()
        
        # Kullanƒ±cƒ± mesajƒ±nƒ± g√∂ster
        self.add_message("Siz", user_message, "#00ff88")
        
        # Giri≈ü alanƒ±nƒ± temizle
        self.message_entry.delete("1.0", tk.END)
        self.update_char_count()
        
        # AI yanƒ±tƒ±nƒ± thread'de al
        thread = threading.Thread(target=self.process_ai_response, args=(user_message,), daemon=True)
        thread.start()
        
    def process_ai_response(self, user_message: str):
        """AI yanƒ±tƒ±nƒ± i≈üle - thread i√ßinde √ßalƒ±≈üƒ±r"""
        try:
            self.root.after(0, lambda: self.update_status("ü§î D√º≈ü√ºn√ºyor...", "#ffaa00"))
            
            # AI yanƒ±tƒ±nƒ± al
            ai_response = self.get_ai_response(user_message)
            
            # Ana thread'de UI g√ºncelle
            self.root.after(0, lambda: self.add_message("Asistan", ai_response, "#00b4d8"))
            self.root.after(0, lambda: self.update_status("‚úì Yanƒ±t alƒ±ndƒ±", "#00ff88"))
            
        except Exception as e:
            error_msg = f"‚ùå **Kritik Hata**\n\n{type(e).__name__}: {str(e)}"
            self.root.after(0, lambda: self.add_message("Sistem", error_msg, "#ff4444"))
            self.root.after(0, lambda: self.update_status("‚úó Hata olu≈ütu", "#ff4444"))
            
        finally:
            # UI'yi tekrar aktif et
            self.root.after(0, self.reset_ui)
            
    def reset_ui(self):
        """UI'yi varsayƒ±lan duruma getir"""
        self.is_processing = False
        self.hide_progress()
        self.send_button.config(state=tk.NORMAL, text="‚û§\nG√ñNDER")
        self.message_entry.config(state=tk.NORMAL)
        self.message_entry.focus()
        self.root.after(3000, lambda: self.update_status("‚úì Hazƒ±r", "#888888"))

def main():
    """Uygulamayƒ± ba≈ülat"""
    root = tk.Tk()
    
    # Uygulama simgesi (opsiyonel)
    try:
        root.iconbitmap('icon.ico')
    except:
        pass
    
    # Uygulama olu≈ütur
    app = AIAssistant(root)
    
    # Pencere kapatma onayƒ±
    def on_closing():
        if messagebox.askokcancel("√áƒ±kƒ±≈ü", "Uygulamadan √ßƒ±kmak istiyor musunuz?"):
            root.quit()
            
    root.protocol("WM_DELETE_WINDOW", on_closing)
    
    # Uygulamayƒ± √ßalƒ±≈ütƒ±r
    root.mainloop()

if __name__ == "__main__":
    main()
